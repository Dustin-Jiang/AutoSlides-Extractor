name: Build AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build AppImage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          wget \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          libqt6svg6-dev \
          libopencv-dev \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswscale-dev \
          libgl1-mesa-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: Build
      run: cmake --build build --parallel $(nproc)

    - name: Install to AppDir
      run: |
        # Install the application binary
        DESTDIR=AppDir cmake --install build
        
        # Install desktop file and icon manually since CMakeLists.txt doesn't seem to do it
        install -D -m 644 resources/linux/AutoSlidesExtractor.desktop AppDir/usr/share/applications/AutoSlidesExtractor.desktop
        install -D -m 644 resources/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/autoslides-extractor.png

    - name: Download linuxdeploy and plugins
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-plugin-qt-x86_64.AppImage

    - name: Build AppImage
      env:
        QMAKE: /usr/lib/qt6/bin/qmake
      run: |
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --plugin qt \
          --output appimage
          
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: AutoSlidesExtractor-AppImage
        path: AutoSlidesExtractor*.AppImage
